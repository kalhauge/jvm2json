name: Build and Distribute Docker

on: 
  push:
    tags: [ 'v*' ]
  pull_request: 
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}


jobs:
  build-docker:
    runs-on: ubuntu-latest
   
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix with flakes
        uses: DeterminateSystems/determinate-nix-action@v3.12.1
    
      - name: Build Docker image with Nix
        run: nix build .#packages.x86_64-linux.docker --print-build-logs
    
      - name: Upload Docker tarball as artifact
        uses: actions/upload-artifact@v4
        with:
          name: jpamb-docker-${{ github.sha }}
          path: result
          retention-days: 7
      
      - name: Push to GitHub Container Registry
        if: |
          github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: |
          # Login to GitHub Container Registry
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          # Get the loaded image name
          LOCAL_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep jpamb | head -1)
          echo "Local image: $LOCAL_IMAGE"

          VERSION=${GITHUB_REF#refs/tags/}
          TAGS="ghcr.io/${{ env.IMAGE_NAME }}:$VERSION ghcr.io/${{ env.IMAGE_NAME }}:latest"

          # Tag and push
          for TAG in $TAGS; do
            echo "Pushing $TAG..."
            docker tag "$LOCAL_IMAGE" "$TAG"
            docker push "$TAG"
          done

